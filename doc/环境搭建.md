# Filehub-cloud 环境搭建详细指南

## 一、环境要求

### 1.1 服务器环境

- **操作系统**：Ubuntu 20.04 64位（推荐）或 Ubuntu 18.04/22.04
- **服务器类型**：VMware 虚拟机或云服务器
- **示例 IP**：192.168.1.4（请根据实际情况修改）
- **权限说明**：如果机器没有开启 root 权限，在需要权限的命令前加 `sudo`

### 1.2 依赖软件清单

| 软件/库 | 版本 | 用途 |
|---------|------|------|
| gcc/g++ | 9.4.0+ | C++ 编译器 |
| cmake | 3.0+ | 构建工具 |
| MySQL | 8.0 | 数据库 |
| Redis | 6.2.3 | 缓存 |
| FastDFS | 6.0.7 | 分布式文件存储 |
| libfastcommon | 1.0.50 | FastDFS 基础库 |
| Nginx | 1.16.1 | Web 服务器 |
| fastdfs-nginx-module | 1.22 | FastDFS Nginx 模块 |
| nginx-upload-module | 2.2.0 | 文件上传模块 |
| PCRE | 8.44 | Nginx 依赖 |
| zlib | 1.2.11 | Nginx 依赖 |
| OpenSSL | 1.1.1g | Nginx 依赖 |
| jsoncpp | - | JSON 解析库 |
| uuid-dev | - | UUID 生成库 |

## 二、基础环境安装

### 2.1 安装编译工具链

```bash
# 更新软件包列表
apt-get update

# 安装 gcc、g++ 编译器
apt-get install gcc
apt-get install g++
apt-get install build-essential
apt-get install libtool

# 安装 cmake
apt-get install cmake

# 注意：如果是 Ubuntu 16.04，需要升级 gcc/g++，可参考 gRPC 章节的升级文档
```

### 2.2 安装项目依赖库

```bash
# 安装 JSON 库
sudo apt-get install libjsoncpp-dev

# 安装 UUID 库
sudo apt-get install uuid-dev
```

## 三、MySQL 安装与配置

### 3.1 安装 MySQL

```bash
# 更新软件包列表
apt-get update

# 安装 MySQL Server
apt-get install mysql-server

# 安装 MySQL Client
apt-get install mysql-client

# 安装 MySQL 开发库
apt-get install libmysqlclient-dev
```

### 3.2 配置 MySQL 密码

如果安装 mysql-server 时没有提示设置密码，需要手动设置：

**MySQL 5.7 及以下版本：**

```bash
# 登录 MySQL（如果没有密码直接按回车）
mysql -u root -p

# 在 MySQL 命令行中执行
use mysql;
update user set authentication_string=PASSWORD("123456") where user='root';
update user set plugin="mysql_native_password";
flush privileges;
quit;

# 重启 MySQL
/etc/init.d/mysql restart
```

**MySQL 8.0（Ubuntu 20.04）：**

```bash
# 登录 MySQL（如果没有密码直接按回车）
mysql -u root -p

# 在 MySQL 命令行中执行
use mysql;
ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';
flush privileges;
quit;

# 重启 MySQL
/etc/init.d/mysql restart
```

### 3.3 MySQL 服务管理

```bash
# 启动 MySQL
sudo /etc/init.d/mysql start

# 停止 MySQL
sudo /etc/init.d/mysql stop

# 重启 MySQL
sudo /etc/init.d/mysql restart
```

### 3.4 导入数据库

```bash
# 登录 MySQL
mysql -uroot -p

# 导入数据库（请根据实际路径修改）
mysql> source /path/to/filehub-cloud/sql/filehub.sql;

# 验证数据库创建
mysql> use filehub;
mysql> show tables;
```

应该看到以下表：
- `file_info` - 文件信息表
- `share_file_list` - 共享文件列表
- `share_picture_list` - 共享图片列表
- `user_file_list` - 用户文件列表
- `user_info` - 用户信息表

## 四、Redis 安装与配置

### 4.1 安装 Redis

```bash
# 克隆 Redis 源码
git clone https://gitee.com/mirrors/redis.git
cd redis

# 切换到指定版本
git checkout 6.2.3

# 编译安装
make
make install

# 编译 hiredis（Redis C 客户端库）
cd ./deps/hiredis
make
make install
```

### 4.2 验证安装

```bash
# 查看 Redis 版本
redis-server -v
# 应该显示：Redis server v=6.2.3 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=77053994c60ea3c2
```

### 4.3 配置 Redis

```bash
# 进入 Redis 源码目录
cd /path/to/redis

# 编辑配置文件
vim redis.conf

# 找到 daemonize no，改为 daemonize yes（后台运行）
# daemonize yes
```

### 4.4 启动 Redis

```bash
# 启动 Redis（使用配置文件）
redis-server redis.conf

# 测试 Redis 是否正常工作
redis-cli -h 127.0.0.1 -p 6379

# 在 Redis 命令行中测试
127.0.0.1:6379> set name GuLu
OK
127.0.0.1:6379> get name
"GuLu"
```


## 五、FastDFS 安装与配置

### 5.1 安装 libfastcommon

```bash
# 克隆 libfastcommon（使用国内镜像）
git clone https://gitee.com/fastdfs100/libfastcommon.git
cd libfastcommon

# 切换到指定版本
git checkout V1.0.50

# 编译安装
./make.sh
sudo ./make.sh install
```

### 5.2 安装 FastDFS

```bash
# 克隆 FastDFS（使用国内镜像）
git clone https://gitee.com/fastdfs100/fastdfs.git
cd fastdfs

# 切换到指定版本
git checkout V6.07

# 编译安装
./make.sh
sudo ./make.sh install
```

### 5.3 FastDFS 组件说明

FastDFS 服务包含三个角色：

- **Tracker Server（跟踪服务器）**：负责管理所有的 storage server 和 group，建立 group 到 storage server list 的映射表
- **Storage Server（存储服务器）**：以组（group）为单位组织，负责实际文件存储
- **Client（客户端）**：提供文件访问接口（upload、download、delete 等）

### 5.4 配置 Tracker

```bash
# 创建 Tracker 存储目录
sudo mkdir -p /home/fastdfs/tracker

# 复制配置文件
cd /etc/fdfs
sudo cp tracker.conf.sample tracker.conf

# 编辑配置文件
sudo vim tracker.conf
```

**关键配置项：**

```ini
# 启用配置文件（默认为 false，表示启用配置文件）
disabled=false

# Tracker 服务端口（默认为 22122）
port=22122

# 存储日志和数据的根目录
base_path=/home/fastdfs/tracker
```

### 5.5 配置 Storage

```bash
# 创建 Storage 存储目录
sudo mkdir -p /home/fastdfs/storage

# 复制配置文件
cd /etc/fdfs
sudo cp storage.conf.sample storage.conf

# 编辑配置文件
sudo vim storage.conf
```

**关键配置项：**

```ini
# 启用配置文件
disabled=false

# Storage 服务端口（默认为 23000）
port=23000

# 数据和日志文件存储根目录
base_path=/home/fastdfs/storage

# 存储路径，访问时路径为 M00
# store_path1 则为 M01，以此递增到 M99
store_path0=/home/fastdfs/storage

# Tracker 服务器 IP 地址和端口
# 注意：单机搭建时也不要写 127.0.0.1，要写实际 IP
# tracker_server 可以多次出现，如果有多个，则配置多个
tracker_server=192.168.1.4:22122

# HTTP 访问文件的端口（已废弃，由 Nginx 提供）
http.server_port=8888
```

**重要提示**：`tracker_server` 必须填写实际 IP 地址（如 192.168.1.4），不要使用 127.0.0.1。

### 5.6 启动 Tracker 和 Storage

```bash
# 启动 Tracker 服务
sudo /etc/init.d/fdfs_trackerd start

# 启动 Storage 服务
sudo /etc/init.d/fdfs_storaged start

# 查看 Tracker 是否启动（如果是云服务器，注意要开放对应端口 22122）
sudo lsof -i:22122

# 查看 Storage 是否启动（如果是云服务器，注意要开放对应端口 23000）
sudo lsof -i:23000
```

### 5.7 验证 FastDFS 状态

```bash
# 查看 Storage 是否已经注册到 Tracker 服务器中
sudo /usr/bin/fdfs_monitor /etc/fdfs/storage.conf

# 当查看到 ip_addr = 192.168.1.4: (localhost.localdomain)  ACTIVE
# ACTIVE 表示成功
```

### 5.8 查看日志

```bash
# Tracker 日志
tail -f /home/fastdfs/tracker/logs/trackerd.log

# Storage 日志
tail -f /home/fastdfs/storage/logs/storaged.log
```

### 5.9 FastDFS 服务管理命令

**Tracker 服务：**

```bash
# 启动
sudo /etc/init.d/fdfs_trackerd start

# 停止
sudo /etc/init.d/fdfs_trackerd stop

# 重启
sudo /etc/init.d/fdfs_trackerd restart
```

**Storage 服务：**

```bash
# 启动
sudo /etc/init.d/fdfs_storaged start

# 停止
sudo /etc/init.d/fdfs_storaged stop

# 重启
sudo /etc/init.d/fdfs_storaged restart
```

### 5.10 配置客户端并测试上传

```bash
# 创建客户端目录
sudo mkdir -p /home/fastdfs/client

# 复制客户端配置文件
sudo cp /etc/fdfs/client.conf.sample /etc/fdfs/client.conf

# 编辑客户端配置
sudo vim /etc/fdfs/client.conf
```

**关键配置项：**

```ini
# 存储日志文件的基本路径
base_path=/home/fastdfs/client

# Tracker 服务器 IP 地址与端口号
tracker_server=192.168.1.4:22122
```

**测试上传文件：**

```bash
# 创建测试文件
touch test.txt
echo "Hello FastDFS" > test.txt

# 上传文件到 FastDFS
/usr/bin/fdfs_upload_file /etc/fdfs/client.conf test.txt

# 返回文件 ID，如：group1/M00/00/00/ctepQmIWJTCAcldiAAAHuj79dAY04.txt
# 表示上传成功
```

**测试下载文件：**

```bash
# 下载文件（使用上面返回的 fileid）
fdfs_download_file /etc/fdfs/client.conf group1/M00/00/00/ctepQmIWJTCAcldiAAAHuj79dAY04.txt

# 查看当前目录，应该能看到下载的文件
ls
```

**测试删除文件：**

```bash
# 删除文件
fdfs_delete_file /etc/fdfs/client.conf group1/M00/00/00/ctepQmIWJTCAcldiAAAHuj79dAY04.txt

# 可以进入 /home/fastdfs/storage/data/00/00 路径查看文件是否被删除
```

## 六、Nginx 安装与配置

### 6.1 安装 Nginx 依赖库

#### 6.1.1 安装 PCRE 库

```bash
# 下载 PCRE 源码包
wget https://sourceforge.net/projects/pcre/files/pcre/8.44/pcre-8.44.tar.gz

# 解压
tar -zxvf pcre-8.44.tar.gz
cd pcre-8.44/

# 编译安装
./configure
make
sudo make install
```

#### 6.1.2 安装 zlib 库

```bash
# 下载 zlib 源码包
wget https://nchc.dl.sourceforge.net/project/libpng/zlib/1.2.11/zlib-1.2.11.tar.gz

# 解压
tar -zxvf zlib-1.2.11.tar.gz
cd zlib-1.2.11/

# 编译安装
./configure
make
sudo make install
```

#### 6.1.3 安装 OpenSSL 开发库

```bash
# 下载 OpenSSL 源码包
wget https://www.openssl.org/source/openssl-1.1.1g.tar.gz

# 解压
tar -zxvf openssl-1.1.1g.tar.gz
cd openssl-1.1.1g/

# 编译安装
./config
make
sudo make install
```

### 6.2 备份原有 Nginx（如果已安装）

```bash
# 如果已经安装了其他版本的 nginx，建议先备份
cd /usr/local/
mv nginx bk-nginx-20240723
```

### 6.3 下载并编译 Nginx

```bash
# 下载 Nginx 源码包
wget http://nginx.org/download/nginx-1.16.1.tar.gz

# 解压
tar -zxvf nginx-1.16.1.tar.gz
cd nginx-1.16.1/

# 配置（注意 openssl-1.1.1g 的目录位置）
./configure --with-cc-opt="-Wno-error" \
  --prefix=/usr/local/nginx \
  --with-http_stub_status_module \
  --with-http_ssl_module \
  --with-http_realip_module \
  --with-http_v2_module \
  --with-openssl=../openssl-1.1.1g

# 编译安装
make
sudo make install
```

### 6.4 解决动态库问题

如果启动 Nginx 时出现以下错误：

```
/usr/local/nginx/sbin/nginx: error while loading shared libraries: libpcre.so.1: cannot open shared object file: No such file or directory
```

执行以下命令：

```bash
sudo ldconfig
```

### 6.5 验证 Nginx 安装

```bash
# 查看 Nginx 进程
sudo ps -ef | grep nginx

# 应该看到：
# root      47583      1  0 20:15 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
# nobody    47584  47583  0 20:15 ?        00:00:00 nginx: worker process

# 打开浏览器访问 http://192.168.1.4
# 如果浏览器出现 "Welcome to nginx!" 则表示 Nginx 已经安装并运行成功
```

### 6.6 Nginx 服务管理

```bash
# 默认方式启动 Nginx 服务器（需要 sudo 权限）
sudo /usr/local/nginx/sbin/nginx

# 指定配置文件启动服务器
sudo /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf

# 测试配置信息
sudo /usr/local/nginx/sbin/nginx -t

# 停止 Nginx
sudo /usr/local/nginx/sbin/nginx -s stop

# 重新加载配置（不停止服务）
sudo /usr/local/nginx/sbin/nginx -s reload
```

## 七、FastDFS Nginx 模块安装

### 7.1 下载 fastdfs-nginx-module

```bash
# 克隆 fastdfs-nginx-module
git clone https://github.com/happyfish100/fastdfs-nginx-module.git
cd fastdfs-nginx-module

# 切换到指定版本
git checkout V1.22

# 查看模块路径（后续编译 Nginx 时需要）
cd fastdfs-nginx-module/src
pwd
# 记录这个路径，例如：/home/gulu/filehub/fastdfs-nginx-module/src
```

### 7.2 下载 nginx-upload-module

```bash
# 下载原始版本（有 bug）
wget http://www.grid.net.ru/nginx/download/nginx_upload_module-2.2.0.tar.gz

# 解压
tar -zxvf nginx_upload_module-2.2.0.tar.gz

# 下载修复版本
git clone https://github.com/winshining/nginx-upload-module.git

# 拷贝修复版本的内容到原始版本目录
cd nginx-upload-module
cp -arf * ../nginx_upload_module-2.2.0

# 进入修复后的目录
cd ../nginx_upload_module-2.2.0
pwd
# 记录这个路径，例如：/home/gulu/filehub/nginx_upload_module-2.2.0
```

### 7.3 重新编译 Nginx 并添加模块

```bash
# 进入 Nginx 源码目录
cd /path/to/nginx-1.16.1/

# 清理之前的编译文件
make clean

# 配置添加模块（请根据实际路径修改）
./configure --with-cc-opt="-Wno-error" \
  --prefix=/usr/local/nginx \
  --with-http_stub_status_module \
  --with-http_ssl_module \
  --with-http_realip_module \
  --with-http_v2_module \
  --with-openssl=../openssl-1.1.1g \
  --add-module=/home/gulu/filehub/fastdfs-nginx-module/src \
  --add-module=/home/gulu/filehub/nginx_upload_module-2.2.0

# 注意：--add-module 后面的路径要替换为你的实际路径
```

### 7.4 修改 Makefile 添加头文件路径

```bash
# 编辑 Makefile
vim objs/Makefile

# 在 ALL_INCS 部分添加以下两行（注意格式和缩进）
ALL_INCS = -I src/core \
    -I /usr/include/fastdfs \
    -I /usr/include/fastcommon \
    -I src/event \
    -I src/event/modules \
```

**特别注意**：加入两行后 `-I` 和 `\` 的颜色要和原来一致，否则会报错。

### 7.5 编译安装 Nginx

```bash
# 编译
make

# 安装
sudo make install

# 验证编译是否正常
sudo /usr/local/nginx/sbin/nginx -V

# 应该看到编译参数中包含：
# --add-module=/path/to/fastdfs-nginx-module/src
# --add-module=/path/to/nginx_upload_module-2.2.0
```

### 7.6 配置 fastdfs-nginx-module

#### 7.6.1 拷贝配置文件

```bash
# 拷贝 fastdfs-nginx-module 配置文件
sudo cp /path/to/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs/

# 拷贝 fastdfs 配置文件
cd /path/to/fastdfs
sudo cp conf/http.conf /etc/fdfs/
sudo cp conf/mime.types /etc/fdfs/
```

#### 7.6.2 创建目录并修改配置

```bash
# 创建目录
sudo mkdir -p /home/fastdfs/mod_fastdfs

# 编辑配置文件
sudo vim /etc/fdfs/mod_fastdfs.conf
```

**关键配置项：**

```ini
# 保存日志目录
base_path=/home/fastdfs/mod_fastdfs

# Tracker 服务器 IP 和端口（确保跟 storage.conf 一致）
tracker_server=192.168.1.4:22122

# url 中是否包含 group 名称，改为 true，包含 group
url_have_group_name=true

# store_path0 的路径必须和 storage.conf 的配置一致
store_path0=/home/fastdfs/storage

# 其他默认配置
group_name=group1
storage_server_port=23000
store_path_count=1
```

### 7.7 配置 Nginx

```bash
# 编辑 Nginx 配置文件
sudo vim /usr/local/nginx/conf/nginx.conf
```

**关键配置（完整示例）：**

```nginx
user  root;
worker_processes  4;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;
    
    # 文件上传大小限制 30M
    client_max_body_size 30m;

    server {
        listen       80;
        server_name  0.0.0.0;

        index index.html index.htm default.htm default.html;
        root /path/to/front;  # 前端页面路径，请根据实际情况修改

        # 跨域配置
        add_header Access-Control-Allow-Methods *;
        add_header Access-Control-Max-Age 3600;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Allow-Origin $http_origin;
        add_header Access-Control-Allow-Headers $http_access_control_request_headers;

        # 前端页面
        location / {
            root /path/to/front;  # 前端页面路径，请根据实际情况修改
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # FastDFS 文件下载
        location ~/group([0-9])/M([0-9])([0-9]) {
            ngx_fastdfs_module;
        }

        # 文件上传代理
        location /api/upload {
            upload_pass   @api_upload;
            upload_store /root/tmp 1;
            upload_store_access user:r;
            upload_set_form_field "${upload_field_name}_name" $upload_file_name;
            upload_set_form_field "${upload_field_name}_content_type" $upload_content_type;
            upload_set_form_field "${upload_field_name}_path" $upload_tmp_path;
            upload_aggregate_form_field "${upload_field_name}_md5" $upload_file_md5;
            upload_aggregate_form_field "${upload_field_name}_size" $upload_file_size;
            upload_pass_form_field "^user";
        }

        location @api_upload {
            proxy_pass   http://127.0.0.1:8081;
        }

        # API 代理
        location /api/ {
            proxy_pass http://127.0.0.1:8081;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

**重要配置说明：**

1. `user root;` - 避免权限问题
2. `client_max_body_size 30m;` - 控制最大文件上传大小
3. `root /path/to/tc-front;` - 前端页面路径（需要修改为实际路径）
4. `location ~/group([0-9])/M([0-9])([0-9])` - FastDFS 文件下载路由
5. `location /api/upload` - 文件上传处理
6. `proxy_pass http://127.0.0.1:8081;` - 后端服务地址

### 7.8 重启 Nginx 并验证

```bash
# 测试配置文件
sudo /usr/local/nginx/sbin/nginx -t

# 停止 Nginx
sudo /usr/local/nginx/sbin/nginx -s stop

# 启动 Nginx
sudo /usr/local/nginx/sbin/nginx

# 查看 Nginx 进程（应该看到 master 和 worker 进程）
sudo ps -ef | grep nginx
```

**如果 Nginx 启动异常（只有 master 进程，没有 worker 进程）：**

```bash
# 查看错误日志
tail -n 20 -f /usr/local/nginx/logs/error.log

# 常见原因：
# 1. base_path 对应的路径没有创建
# 2. tracker_server 配置错误
# 3. store_path0 配置错误
```

### 7.9 测试 FastDFS Nginx 模块

```bash
# 在服务器中测试上传
touch test.txt
echo "Hello, GuLu. This is a test..." > test.txt

# 上传文件到 FastDFS
fdfs_upload_file /etc/fdfs/client.conf test.txt

# 得到文件 ID，如：group1/M00/00/00/ctepQmIWLzWAHzHrAAAAKTIQHvk745.txt

# 浏览器访问（使用实际 IP 和 fileid）
http://192.168.1.4:80/group1/M00/00/00/ctepQmIWLzWAHzHrAAAAKTIQHvk745.txt

# 浏览器能显示对应的文本信息，说明配置成功
```

## 八、项目编译与配置

### 8.1 编译项目

```bash
# 进入项目根目录
cd /path/to/filehub-cloud

# 创建构建目录
mkdir -p build
cd build

# 使用 CMake 配置（Debug 模式）
cmake -DCMAKE_BUILD_TYPE=Debug ..

# 或者使用 Release 模式
cmake -DCMAKE_BUILD_TYPE=Release ..

# 多线程编译
make -j4

# 编译完成后，可执行文件在 build/bin/ 目录下
# filehub - 服务器程序
# filehub-client - 客户端测试程序
```

### 8.2 配置文件说明

#### 8.2.1 复制配置文件

```bash
# 编译完成后，将配置文件拷贝到 build 目录
cd /path/to/filehub-cloud/build
cp ../application/filehub/tc_http_server.conf .
```

#### 8.2.2 编辑配置文件

```bash
# 编辑配置文件
vim tc_http_server.conf
```

**完整配置示例：**

```ini
# 绑定的 IP 和端口
http_bind_ip=0.0.0.0
http_bind_port=8081

# IO 线程数量（SubReactor 数量）
num_event_loops=4

# 业务线程数量
num_threads=64

# epoll 超时时间（毫秒）
timeout_ms=10

# nodelay 参数
nodelay=1

# 日志级别
# TRACE = 0, DEBUG = 1, INFO = 2, WARN = 3, ERROR = 4, FATAL = 5
log_level=2

# 是否开启短链（先禁用，暂未实现）
enable_shorturl=0
shorturl_server_address=127.0.0.1:50051
shorturl_server_access_token=e8n05nr9jey84prEhw5u43th0yi294780yjr3h7sksSdkFdDngKi

# FastDFS 配置
dfs_path_client=/etc/fdfs/client.conf
storage_web_server_ip=192.168.1.4   # 修改为自己地址
storage_web_server_port=80

# MySQL 配置
DBInstances=filehub_master,filehub_slave

# filehub_master（主库）
filehub_master_host=localhost
filehub_master_port=3306
filehub_master_dbname=filehub
filehub_master_username=root
filehub_master_password=123456
filehub_master_maxconncnt=128

# filehub_slave（从库）
filehub_slave_host=localhost
filehub_slave_port=3306
filehub_slave_dbname=filehub
filehub_slave_username=root
filehub_slave_password=123456
filehub_slave_maxconncnt=128

# Redis 配置
CacheInstances=token,ranking_list

# token 相关
token_host=127.0.0.1
token_port=6379
token_db=0
token_maxconncnt=128

# 排行榜相关
ranking_list_host=127.0.0.1
ranking_list_port=6379
ranking_list_db=1
ranking_list_maxconncnt=128
```

**配置项说明：**

- `http_bind_ip`：服务器绑定的 IP，0.0.0.0 表示监听所有网卡
- `http_bind_port`：服务器监听端口
- `num_event_loops`：IO 线程数（SubReactor 数量），建议 4-8
- `num_threads`：业务线程池大小，建议 64-128
- `log_level`：日志级别，生产环境建议 WARN(3) 或 ERROR(4)
- `dfs_path_client`：FastDFS 客户端配置文件路径
- `storage_web_server_ip`：FastDFS Storage 的 Web 服务器 IP
- `storage_web_server_port`：FastDFS Storage 的 Web 服务器端口
- `filehub_master_*`：MySQL 主库配置
- `token_*`：Redis Token 缓存配置（db=0）
- `ranking_list_*`：Redis 排行榜缓存配置（db=1）

## 九、服务启动

### 9.1 启动顺序

按照以下顺序启动服务：

1. **MySQL**
2. **Redis**
3. **FastDFS Tracker**
4. **FastDFS Storage**
5. **Nginx**
6. **Filehub 服务**

### 9.2 启动脚本示例

```bash
#!/bin/bash

# 启动 MySQL
sudo /etc/init.d/mysql start

# 启动 Redis
redis-server /path/to/redis/redis.conf

# 启动 FastDFS Tracker
sudo /etc/init.d/fdfs_trackerd start

# 启动 FastDFS Storage
sudo /etc/init.d/fdfs_storaged start

# 启动 Nginx
sudo /usr/local/nginx/sbin/nginx

# 启动 Filehub 服务（需要 root 权限）
cd /path/to/filehub-cloud/build
sudo ./bin/filehub ./tc_http_server.conf
```

### 9.3 验证服务状态

```bash
# 检查 MySQL
sudo systemctl status mysql
# 或
sudo /etc/init.d/mysql status
mysql -uroot -p -e "SHOW DATABASES;"

# 检查 Redis
redis-cli -h 127.0.0.1 -p 6379 ping
# 应该返回 PONG

# 检查 FastDFS Tracker
sudo lsof -i:22122
# 或
sudo /usr/bin/fdfs_monitor /etc/fdfs/storage.conf

# 检查 FastDFS Storage
sudo lsof -i:23000

# 检查 Nginx
sudo /usr/local/nginx/sbin/nginx -t
sudo ps -ef | grep nginx
# 应该看到 master 和 worker 进程

# 检查 Filehub 服务
sudo ps -ef | grep filehub
# 或查看日志
tail -f /path/to/filehub/logs/filehub.log
```

### 9.4 服务停止

```bash
# 停止 Filehub 服务
sudo pkill filehub

# 停止 Nginx
sudo /usr/local/nginx/sbin/nginx -s stop

# 停止 FastDFS Storage
sudo /etc/init.d/fdfs_storaged stop

# 停止 FastDFS Tracker
sudo /etc/init.d/fdfs_trackerd stop

# 停止 Redis
redis-cli -h 127.0.0.1 -p 6379 shutdown

# 停止 MySQL
sudo /etc/init.d/mysql stop
```

## 十、功能测试

### 10.1 基础功能测试

#### 测试用户注册

```bash
curl -X POST http://192.168.1.4:8081/api/reg \
  -H "Content-Type: application/json" \
  -d '{
    "userName": "testuser",
    "nickName": "测试用户",
    "firstPwd": "123456",
    "phone": "13800138000",
    "email": "test@example.com"
  }'
```

预期返回：
```json
{
  "code": 0,
  "msg": "注册成功"
}
```

#### 测试用户登录

```bash
curl -X POST http://192.168.1.4:8081/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "userName": "testuser",
    "pwd": "123456"
  }'
```

预期返回：
```json
{
  "code": 0,
  "token": "xxx...",
  "msg": "登录成功"
}
```

#### 测试文件上传

```bash
# 先计算文件 MD5
curl -X POST http://192.168.1.4:8081/api/md5 \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "test.txt",
    "fileSize": 1024
  }'

# 上传文件（需要先通过 Nginx 上传模块）
curl -X POST http://192.168.1.4/api/upload \
  -F "file=@/path/to/test.txt" \
  -F "user=testuser" \
  -F "md5=xxx" \
  -F "fileName=test.txt"
```

#### 测试文件列表

```bash
# 获取我的文件列表
curl -X POST http://192.168.1.4:8081/api/myfiles \
  -H "Content-Type: application/json" \
  -H "Token: xxx" \
  -d '{
    "user": "testuser",
    "start": 0,
    "count": 10
  }'

# 获取共享文件列表
curl -X POST http://192.168.1.4:8081/api/sharefiles \
  -H "Content-Type: application/json" \
  -d '{
    "start": 0,
    "count": 10
  }'
```

### 10.2 FastDFS 测试

```bash
# 测试上传文件到 FastDFS
/usr/bin/fdfs_upload_file /etc/fdfs/client.conf /path/to/test.txt
# 返回：group1/M00/00/00/xxx.txt

# 测试下载文件
/usr/bin/fdfs_download_file /etc/fdfs/client.conf group1/M00/00/00/xxx.txt

# 测试通过 HTTP 访问文件
curl http://192.168.1.4/group1/M00/00/00/xxx.txt
```

### 10.3 前端访问测试

在浏览器中访问：
```
http://192.168.1.4
```

应该能看到登录页面，可以正常注册、登录、上传文件等操作。

## 十一、常见问题排查

### 11.1 Nginx 启动异常

**问题：** Nginx 只有 master 进程，没有 worker 进程

**排查步骤：**

```bash
# 查看错误日志
tail -n 50 /usr/local/nginx/logs/error.log

# 常见原因：
# 1. mod_fastdfs.conf 配置错误
# 2. base_path 目录不存在
# 3. tracker_server 配置错误
# 4. store_path0 路径不匹配
```

**解决方案：**

1. 检查 `/etc/fdfs/mod_fastdfs.conf` 配置
2. 确保 `/home/fastdfs/mod_fastdfs` 目录存在
3. 确保 `tracker_server` 和 `store_path0` 配置正确
4. 检查 FastDFS Tracker 和 Storage 是否正常运行

### 11.2 FastDFS 上传失败

**问题：** `tracker_query_storage fail, error no: 2`

**排查步骤：**

```bash
# 查看 Storage 日志
tail -f /home/fastdfs/storage/logs/storaged.log

# 查看 Tracker 日志
tail -f /home/fastdfs/tracker/logs/trackerd.log

# 检查 Storage 是否注册到 Tracker
sudo /usr/bin/fdfs_monitor /etc/fdfs/storage.conf
```

**解决方案：**

1. 检查 `storage.conf` 中的 `tracker_server` 配置
2. 确保 Tracker 服务正常运行
3. 检查网络连接和防火墙设置
4. 确保 `base_path` 和 `store_path0` 目录存在且有写权限

### 11.3 MySQL 连接失败

**问题：** `Can't connect to MySQL server`

**排查步骤：**

```bash
# 检查 MySQL 服务状态
sudo systemctl status mysql

# 测试连接
mysql -uroot -p -h localhost

# 检查配置文件中的用户名密码
cat application/filehub/tc_http_server.conf | grep mysql
```

**解决方案：**

1. 确保 MySQL 服务已启动
2. 检查配置文件中的用户名、密码、数据库名是否正确
3. 检查 MySQL 用户权限
4. 确保数据库已创建并导入了 `sql/filehub.sql`

### 11.4 Redis 连接失败

**问题：** `Connection refused` 或 `redis-server 没有正常启动`

**排查步骤：**

```bash
# 检查 Redis 进程
ps -ef | grep redis

# 测试连接
redis-cli -h 127.0.0.1 -p 6379 ping

# 查看 Redis 日志
tail -f /path/to/redis/logs/redis.log
```

**解决方案：**

1. 确保 Redis 服务已启动：`redis-server redis.conf`
2. 检查 `redis.conf` 中的 `daemonize yes` 配置
3. 确保 Redis 没有设置密码（或配置文件中密码正确）
4. 检查端口是否被占用：`lsof -i:6379`

### 11.5 文件上传阻塞

**问题：** 上传文件时程序卡住不动

**排查步骤：**

```bash
# 查看 Filehub 日志
tail -f /path/to/filehub/logs/filehub.log

# 检查 FastDFS 服务
sudo lsof -i:22122
sudo lsof -i:23000

# 检查 Redis 和 MySQL
redis-cli -h 127.0.0.1 -p 6379 ping
mysql -uroot -p -e "SELECT 1;"
```

**解决方案：**

1. 确保所有基础服务（Redis、MySQL、FastDFS）正常运行
2. 检查 FastDFS 客户端配置 `/etc/fdfs/client.conf`
3. 检查文件权限，确保有写权限
4. 查看详细日志定位具体错误

### 11.6 权限问题

**问题：** `Permission denied` 或文件上传失败

**解决方案：**

1. Filehub 服务需要使用 root 权限启动：`sudo ./bin/filehub`
2. Nginx 配置中设置 `user root;`
3. 确保 FastDFS 相关目录有正确的权限
4. 确保临时文件目录有写权限

### 11.7 端口冲突

**问题：** `Address already in use`

**排查步骤：**

```bash
# 查看端口占用
sudo lsof -i:8081  # Filehub 端口
sudo lsof -i:80     # Nginx 端口
sudo lsof -i:22122  # FastDFS Tracker
sudo lsof -i:23000  # FastDFS Storage
sudo lsof -i:6379   # Redis
sudo lsof -i:3306   # MySQL
```

**解决方案：**

1. 停止占用端口的进程
2. 或修改配置文件使用其他端口

## 十二、性能优化建议

### 12.1 系统参数优化

```bash
# 增加文件描述符限制
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# 优化 TCP 参数
cat >> /etc/sysctl.conf << EOF
net.core.somaxconn = 2048
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
EOF
sysctl -p
```

### 12.2 连接池配置

根据实际负载调整 `tc_http_server.conf` 中的连接池大小：

```ini
# IO 线程数，建议为 CPU 核心数
num_event_loops=4

# 业务线程数，建议为 CPU 核心数 * 8-16
num_threads=64

# MySQL 连接池大小
filehub_master_maxconncnt=128
filehub_slave_maxconncnt=128

# Redis 连接池大小
token_maxconncnt=128
ranking_list_maxconncnt=128
```

### 12.3 Nginx 优化

```nginx
# 在 nginx.conf 中优化
worker_processes 4;              # 工作进程数
worker_connections 1024;          # 每个进程最大连接数
keepalive_timeout 65;             # 保持连接时间
client_max_body_size 30m;         # 最大上传文件大小
```

## 十三、维护与监控

### 13.1 日志管理

```bash
# Filehub 日志位置
/path/to/filehub/logs/filehub.log

# FastDFS 日志位置
/home/fastdfs/tracker/logs/trackerd.log
/home/fastdfs/storage/logs/storaged.log

# Nginx 日志位置
/usr/local/nginx/logs/access.log
/usr/local/nginx/logs/error.log

# 定期清理日志（建议使用 logrotate）
```

### 13.2 监控指标

建议监控以下指标：

- **服务状态**：MySQL、Redis、FastDFS、Nginx、Filehub 进程状态
- **连接数**：数据库连接池使用率、Redis 连接数
- **性能指标**：请求响应时间、QPS、错误率
- **资源使用**：CPU、内存、磁盘 I/O、网络带宽

### 13.3 备份策略

```bash
# MySQL 数据库备份
mysqldump -uroot -p filehub > filehub_backup_$(date +%Y%m%d).sql

# FastDFS 数据备份（定期备份存储目录）
tar -czf fastdfs_backup_$(date +%Y%m%d).tar.gz /home/fastdfs/storage/data

# 配置文件备份
cp -r /etc/fdfs /backup/fdfs_$(date +%Y%m%d)
cp /usr/local/nginx/conf/nginx.conf /backup/nginx_$(date +%Y%m%d).conf
```

## 十四、总结

本文档详细介绍了 Filehub-cloud 项目的完整环境搭建流程，包括：

1. **基础环境准备**：Ubuntu 系统、编译工具链
2. **FastDFS 安装配置**：Tracker、Storage 的安装与配置
3. **Nginx 模块编译**：fastdfs-nginx-module 和 upload-module 的集成
4. **MySQL 和 Redis 配置**：数据库和缓存的安装与初始化
5. **项目编译与配置**：源码编译和配置文件说明
6. **服务启动与验证**：各服务的启动顺序和状态检查
7. **功能测试**：API 接口和前端功能测试
8. **问题排查**：常见问题的诊断和解决方案
9. **性能优化**：系统参数和配置优化建议
10. **维护监控**：日志管理和备份策略

按照本文档步骤操作，可以成功搭建完整的 Filehub-cloud 运行环境。如遇到问题，请参考"常见问题排查"章节，或查看相关服务的日志文件进行诊断。

---

**文档版本：** v1.0  
**最后更新：** 2025年  
**维护者：** Filehub-cloud 开发团队